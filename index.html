<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>DarkPlayer</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { background-color: #111827; color: #f3f4f6; font-family: sans-serif; }
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 3px; }
</style>
</head>
<body class="min-h-screen flex">

<!-- Sidebar -->
<aside class="w-72 bg-gradient-to-b from-gray-800 via-gray-900 to-black p-5 flex flex-col gap-6">
  <div class="text-2xl font-black">DarkPlayer</div>
  <nav class="flex-1">
    <ul class="space-y-3 text-sm">
      <li class="flex items-center gap-3 hover:text-white cursor-pointer">üè† Inicio</li>
    </ul>
  </nav>
  <div class="text-xs opacity-70">¬© Tu estudio ¬∑ Demo</div>
</aside>

<!-- Main -->
<main class="flex-1 p-8 flex flex-col gap-6">
  <header class="flex items-center justify-between">
    <h1 class="text-3xl font-extrabold" id="albumTitle">Cargando...</h1>
  </header>

  <section class="bg-gray-800 p-4 rounded-lg flex flex-col">
    <div class="flex items-center gap-4 mb-4">
      <img id="albumCover" src="" class="w-24 h-24 rounded" />
      <div>
        <div id="albumArtist" class="font-medium"></div>
        <div id="trackCount" class="text-xs opacity-70"></div>
      </div>
    </div>

    <div class="overflow-y-auto" style="max-height: 400px;">
      <table class="w-full table-auto text-left">
        <thead class="text-xs text-gray-400">
          <tr>
            <th class="pl-3">#</th>
            <th>T√≠tulo</th>
            <th class="text-right">Duraci√≥n</th>
          </tr>
        </thead>
        <tbody id="trackList"></tbody>
      </table>
    </div>
  </section>
</main>

<!-- Now Playing Bar -->
<footer class="fixed bottom-0 left-72 right-0 bg-gradient-to-r from-black via-gray-900 to-gray-800 p-3">
  <div class="max-w-[1200px] mx-auto flex items-center justify-between gap-4">
    <div class="flex items-center gap-3 w-1/3">
      <img id="currentCover" src="" class="w-16 h-16 rounded" />
      <div>
        <div id="currentTitle" class="font-semibold"></div>
        <div id="currentArtist" class="text-xs opacity-70"></div>
      </div>
    </div>

    <div class="flex flex-col items-center gap-2 w-1/3">
      <div class="flex items-center gap-6">
        <button id="prevBtn" class="p-2 rounded hover:bg-white/5">‚èÆ</button>
        <button id="playPauseBtn" class="p-3 rounded-full bg-white/5">‚ñ∂</button>
        <button id="nextBtn" class="p-2 rounded hover:bg-white/5">‚è≠</button>
      </div>

      <div class="w-full flex items-center gap-3">
        <div id="currentTime" class="text-xs opacity-60">0:00</div>
        <div id="progressBar" class="relative h-2 bg-gray-700 rounded flex-1 cursor-pointer">
          <div id="progressFill" class="absolute left-0 top-0 bottom-0 bg-white/60 rounded" style="width: 0%;"></div>
        </div>
        <div id="totalTime" class="text-xs opacity-60">0:00</div>
      </div>
    </div>

    <div class="flex items-center gap-3 w-1/3 justify-end">
      <div class="text-sm opacity-70">Vol</div>
      <input id="volumeControl" type="range" min="0" max="1" step="0.01" value="0.8" />
    </div>
  </div>
  <audio id="audio"></audio>
</footer>

<script>
const urlParams = new URLSearchParams(window.location.search);
const albumName = urlParams.get('album'); 

const audio = document.getElementById("audio");
const trackList = document.getElementById("trackList");
const albumTitle = document.getElementById("albumTitle");
const albumArtist = document.getElementById("albumArtist");
const albumCover = document.getElementById("albumCover");
const trackCount = document.getElementById("trackCount");
const playBtn = document.getElementById("playPauseBtn");
const currentCover = document.getElementById("currentCover");
const currentTitle = document.getElementById("currentTitle");
const currentArtist = document.getElementById("currentArtist");
const progressFill = document.getElementById("progressFill");
const currentTimeLabel = document.getElementById("currentTime");
const totalTimeLabel = document.getElementById("totalTime");
const volumeControl = document.getElementById("volumeControl");

let tracks = [];
let current = null;
let isPlaying = false;
audio.volume = 0.8;

function formatTime(sec) {
  const m = Math.floor(sec / 60);
  const s = Math.floor(sec % 60).toString().padStart(2, "0");
  return `${m}:${s}`;
}

async function loadAlbum(name) {
  try {
    // Determine artist folder based on album name
    let artistFolder = "";
    let coverFile = "default.jpg"; // Default cover
    if (name === "Formula2") {
      artistFolder = "RomeoSantos";
      coverFile = "Formula2.jpg"; // Adjust based on actual file name in assets/portadas
    } else if (name === "UnVeranoSinTi") {
      artistFolder = "BadBunny";
      coverFile = "UnVeranoSinTi.jpg"; // Adjust based on actual file name in assets/portadas
    }

    // Fetch JSON from GitHub
    const jsonUrl = `https://raw.githubusercontent.com/lzrdrz10/musiclive/main/${artistFolder}/${name}.json`;
    const res = await fetch(jsonUrl);
    if (!res.ok) throw new Error(`Failed to fetch JSON: ${res.status}`);
    const data = await res.json();

    // Update album metadata
    albumTitle.textContent = data[0].album || name;
    albumArtist.textContent = data[0].artist || "Desconocido";
    
    // Set album cover from GitHub
    albumCover.src = `https://raw.githubusercontent.com/lzrdrz10/musiclive/main/assets/portadas/${coverFile}`;
    
    // Map tracks and set cover URLs
    tracks = data.map(track => ({
      ...track,
      cover: `https://raw.githubusercontent.com/lzrdrz10/musiclive/main/assets/portadas/${coverFile}`
    }));
    
    trackCount.textContent = tracks.length + " canciones";
    loadTrack(tracks[0]);
    renderTracks(tracks);
  } catch(e) {
    console.error("Error cargando el √°lbum:", e);
    albumTitle.textContent = "Error al cargar el √°lbum";
  }
}

function loadTrack(track) {
  current = track;
  audio.src = track.url;
  currentCover.src = track.cover;
  currentTitle.textContent = track.title;
  currentArtist.textContent = track.artist;
  totalTimeLabel.textContent = formatTime(track.duration);
  renderTracks(tracks);
}

function renderTracks(list) {
  trackList.innerHTML = "";
  list.forEach(t => {
    const tr = document.createElement("tr");
    tr.className = `cursor-pointer hover:bg-gray-700/30 ${t.id === current.id ? "bg-gray-700/60" : ""}`;
    tr.innerHTML = `
      <td class="pl-3 py-3">${t.id}</td>
      <td>
        <div class="flex items-center gap-3">
          <img src="${t.cover}" class="w-10 h-10 rounded" />
          <div>
            <div class="font-medium">${t.title}</div>
            <div class="text-xs opacity-70">${t.artist}</div>
          </div>
        </div>
      </td>
      <td class="text-right pr-3">${formatTime(t.duration)}</td>`;
    tr.onclick = () => playTrack(t);
    trackList.appendChild(tr);
  });
}

function playTrack(track) {
  if(current.id !== track.id) loadTrack(track);
  audio.play();
  isPlaying = true;
  playBtn.textContent = "‚è∏";
}

playBtn.onclick = () => {
  if(isPlaying) { audio.pause(); playBtn.textContent = "‚ñ∂"; }
  else { audio.play(); playBtn.textContent = "‚è∏"; }
  isPlaying = !isPlaying;
};

document.getElementById("nextBtn").onclick = () => {
  const idx = tracks.findIndex(t => t.id === current.id);
  playTrack(tracks[(idx+1)%tracks.length]);
};
document.getElementById("prevBtn").onclick = () => {
  const idx = tracks.findIndex(t => t.id === current.id);
  playTrack(tracks[(idx-1+tracks.length)%tracks.length]);
};

audio.ontimeupdate = () => {
  const progress = audio.currentTime / audio.duration * 100;
  progressFill.style.width = progress + "%";
  currentTimeLabel.textContent = formatTime(audio.currentTime);
};

document.getElementById("progressBar").onclick = (e) => {
  const rect = e.target.getBoundingClientRect();
  audio.currentTime = ((e.clientX - rect.left)/rect.width)*audio.duration;
};

volumeControl.oninput = (e) => { audio.volume = e.target.value; };
audio.onended = () => document.getElementById("nextBtn").click();

if(albumName) loadAlbum(albumName);
</script>
</body>
</html>
